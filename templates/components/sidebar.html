<!-- 引入头像样式 -->
<link href="{{ url_for('static', filename='css/avatar.css') }}" rel="stylesheet">

<div class="sidebar-header">
    <div class="user-avatar" id="sidebar-avatar">
        {% if user and user.avatar %}
            <!-- 头像先为空，由 JavaScript 动态更新 -->
            <img src="" alt="{{ user.username }}的头像" class="sidebar-avatar-img" id="sidebar-avatar-img">
        {% elif user %}
            <div class="sidebar-avatar-text">
                {{ user.username[0].upper() }}
            </div>
        {% else %}
            <div class="sidebar-avatar-icon">
                <i class="fas fa-user"></i>
            </div>
        {% endif %}
    </div>
    <h3>{{ user.username if user else '用户' }}</h3>
    <p>{{ user.email if user and user.email else '未设置邮箱' }}</p>
</div>

<nav class="sidebar-nav">
    <a href="{{ url_for('dashboard') }}" class="nav-item">
        <i class="fas fa-home"></i>控制面板
    </a>
    <a href="{{ url_for('oauth_clients') }}" class="nav-item">
        <i class="fas fa-code"></i>我的应用
    </a>
    <a href="{{ url_for('create_oauth_client') }}" class="nav-item">
        <i class="fas fa-plus-circle"></i>创建应用
    </a>
    <a href="{{ url_for('authorized_apps') }}" class="nav-item">
        <i class="fas fa-shield-alt"></i>授权管理
    </a>
    <a href="{{ url_for('settings') }}" class="nav-item">
        <i class="fas fa-cog"></i>账户设置
    </a>
</nav>

<div class="sidebar-footer">
    <a href="{{ url_for('logout') }}" class="nav-item logout-btn">
        <i class="fas fa-sign-out-alt"></i>退出登录
    </a>
</div>

<script>
// 监听头像更新事件
document.addEventListener('DOMContentLoaded', function() {
    const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');

    // 先检查 localStorage 是否有缓存的头像
    const cachedAvatar = localStorage.getItem('userAvatar');
    if (cachedAvatar) {
        // 如果缓存中有头像，直接使用缓存的头像
        sidebarAvatarImg.src = cachedAvatar;
    } else if (sidebarAvatarImg) {
        // 如果没有缓存，从服务器请求头像
        fetch('/api/user/avatar')
            .then(response => response.json())
            .then(data => {
                if (data.avatar) {
                    const avatarUrl = 'data:image/png;base64,' + data.avatar;
                    // 更新头像的src为返回的base64数据
                    sidebarAvatarImg.src = avatarUrl;
                    // 将头像保存到 localStorage 中
                    localStorage.setItem('userAvatar', avatarUrl);
                }
            })
            .catch(error => {
                console.error('获取头像失败:', error);
            });
    }

    // 监听自定义事件，当头像更新时刷新侧边栏显示
    document.addEventListener('avatarUpdated', function(event) {
        const sidebarAvatar = document.getElementById('sidebar-avatar');
        if (sidebarAvatar && event.detail && event.detail.avatarUrl) {
            sidebarAvatar.innerHTML = `<img src="${event.detail.avatarUrl}" alt="用户头像" class="sidebar-avatar-img">`;
            // 更新 localStorage 中的头像
            localStorage.setItem('userAvatar', event.detail.avatarUrl);
        }
    });

    // 监听头像移除事件
    document.addEventListener('avatarRemoved', function() {
        const sidebarAvatar = document.getElementById('sidebar-avatar');
        const username = '{{ user.username if user else "" }}';
        if (sidebarAvatar && username) {
            sidebarAvatar.innerHTML = `<div class="sidebar-avatar-text">${username[0].toUpperCase()}</div>`;
        }
        // 清除缓存中的头像
        localStorage.removeItem('userAvatar');
    });
});
</script>
