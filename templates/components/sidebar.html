<!-- 引入头像样式 -->
<link href="{{ url_for('static', filename='css/avatar.css') }}" rel="stylesheet">

<div class="sidebar-header">
    <div class="user-avatar" id="sidebar-avatar">
        {% if user and user.avatar %}
            <!-- 头像先为空，由 JavaScript 动态更新 -->
            <img src="" alt="" class="sidebar-avatar-img" id="sidebar-avatar-img">
        {% elif user %}
            <div class="sidebar-avatar-text">
                {{ user.username[0].upper() }}
            </div>
        {% else %}
            <div class="sidebar-avatar-icon">
                <i class="fas fa-user"></i>
            </div>
        {% endif %}
    </div>
    <h3>{{ user.username if user else '用户' }}</h3>
    <p>{{ user.email if user and user.email else '未设置邮箱' }}</p>
</div>

<nav class="sidebar-nav">
    <a href="{{ url_for('dashboard') }}" class="nav-item">
        <i class="fas fa-home"></i>控制面板
    </a>
    <a href="{{ url_for('oauth_clients') }}" class="nav-item">
        <i class="fas fa-code"></i>我的应用
    </a>
    <a href="{{ url_for('create_oauth_client') }}" class="nav-item">
        <i class="fas fa-plus-circle"></i>创建应用
    </a>
    <a href="{{ url_for('authorized_apps') }}" class="nav-item">
        <i class="fas fa-shield-alt"></i>授权管理
    </a>
    <a href="{{ url_for('settings') }}" class="nav-item">
        <i class="fas fa-cog"></i>账户设置
    </a>
</nav>

<div class="sidebar-footer">
    <a href="{{ url_for('logout') }}" class="nav-item logout-btn">
        <i class="fas fa-sign-out-alt"></i>退出登录
    </a>
</div>

<script>
// 监听头像更新事件
document.addEventListener('DOMContentLoaded', function() {
    const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
    const currentUserId = {{ user.id if user else 0 }}; // 获取当前用户ID

    // 如果没有用户ID，则不执行缓存逻辑
    if (!currentUserId) return;

    // 使用用户ID作为缓存键
    const avatarCacheKey = `avatar_${currentUserId}`;

    // 检查页面加载类型
    const isPageRefresh = performance.navigation.type === performance.navigation.TYPE_RELOAD ||
                         performance.getEntriesByType("navigation")[0]?.type === "reload";

    // 打开或创建 IndexedDB 数据库
    const request = indexedDB.open('userProfileDB', 2);

    request.onupgradeneeded = function(event) {
        const db = event.target.result;
        // 创建头像存储对象
        if (!db.objectStoreNames.contains('avatars')) {
            db.createObjectStore('avatars', { keyPath: 'id' });
        }
    };

    request.onsuccess = function(event) {
        const db = event.target.result;

        // 如果是页面刷新，直接从服务器获取最新头像
        if (isPageRefresh) {
            fetchLatestAvatar(db, avatarCacheKey, sidebarAvatarImg);
        } else {
            // 否则尝试从缓存加载
            loadAvatarFromCache(db, avatarCacheKey, sidebarAvatarImg);
        }
    };

    // 从服务器获取最新头像
    function fetchLatestAvatar(db, cacheKey, imgElement) {
        fetch('/api/user/avatar')
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取头像失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.avatar) {
                    const avatarUrl = 'data:image/png;base64,' + data.avatar;
                    // 更新头像的src为返回的base64数据
                    imgElement.src = avatarUrl;

                    // 将头像存入 IndexedDB
                    const avatarTransaction = db.transaction(['avatars'], 'readwrite');
                    const avatarStore = avatarTransaction.objectStore('avatars');
                    avatarStore.put({ id: cacheKey, data: avatarUrl });
                } else {
                    // 如果没有头像，显示默认头像
                    showDefaultAvatar();
                }
            })
            .catch(error => {
                console.error('获取头像失败:', error);
                // 如果获取失败，尝试从缓存加载
                loadAvatarFromCache(db, cacheKey, imgElement);
            });
    }

    // 从缓存加载头像
    function loadAvatarFromCache(db, cacheKey, imgElement) {
        const transaction = db.transaction(['avatars'], 'readonly');
        const objectStore = transaction.objectStore('avatars');

        // 尝试从 IndexedDB 中获取当前用户的缓存头像
        const avatarRequest = objectStore.get(cacheKey);

        avatarRequest.onsuccess = function() {
            const cachedAvatar = avatarRequest.result ? avatarRequest.result.data : null;
            if (cachedAvatar) {
                // 如果头像缓存存在，则直接使用缓存的头像
                imgElement.src = cachedAvatar;
            } else {
                // 如果没有缓存，从服务器请求头像
                fetchLatestAvatar(db, cacheKey, imgElement);
            }
        };

        avatarRequest.onerror = function() {
            // 如果读取缓存失败，从服务器获取
            fetchLatestAvatar(db, cacheKey, imgElement);
        };
    }

    // 显示默认头像
    function showDefaultAvatar() {
        const sidebarAvatar = document.getElementById('sidebar-avatar');
        const username = '{{ user.username if user else "" }}';
        if (sidebarAvatar && username) {
            sidebarAvatar.innerHTML = `<div class="sidebar-avatar-text">${username[0].toUpperCase()}</div>`;
        }
    }

    // 监听自定义事件，当头像更新时刷新侧边栏显示
    document.addEventListener('avatarUpdated', function(event) {
        // 检查事件中的用户ID是否与当前用户匹配
        if (event.detail && event.detail.userId === currentUserId) {
            const sidebarAvatar = document.getElementById('sidebar-avatar');
            if (sidebarAvatar && event.detail.avatarUrl) {
                sidebarAvatar.innerHTML = `<img src="${event.detail.avatarUrl}" alt="用户头像" class="sidebar-avatar-img">`;

                // 存储新的头像到 IndexedDB
                const db = request.result;
                const transaction = db.transaction(['avatars'], 'readwrite');
                const objectStore = transaction.objectStore('avatars');
                objectStore.put({ id: avatarCacheKey, data: event.detail.avatarUrl });
            }
        }
    });

    // 监听头像移除事件
    document.addEventListener('avatarRemoved', function(event) {
        // 检查事件中的用户ID是否与当前用户匹配
        if (event.detail && event.detail.userId === currentUserId) {
            const sidebarAvatar = document.getElementById('sidebar-avatar');
            const username = '{{ user.username if user else "" }}';
            if (sidebarAvatar && username) {
                sidebarAvatar.innerHTML = `<div class="sidebar-avatar-text">${username[0].toUpperCase()}</div>`;
            }

            // 清除 IndexedDB 中的当前用户头像
            const db = request.result;
            const transaction = db.transaction(['avatars'], 'readwrite');
            const objectStore = transaction.objectStore('avatars');
            objectStore.delete(avatarCacheKey);
        }
    });
});

// 在用户登录或登出时触发用户切换事件
function triggerUserChange() {
    document.dispatchEvent(new CustomEvent('userChanged'));
}
</script>