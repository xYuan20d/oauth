{% extends "base.html" %}

{% block title %}账户设置 - {{ user.username }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/settings.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/avatar.css') }}" rel="stylesheet">
<!-- 引入Cropper.js CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1><i class="fas fa-cog"></i> 账户设置</h1>
    <p>管理您的个人信息、安全设置和账户偏好</p>
</div>
{% endblock %}

{% block content %}
<!-- Avatar Settings -->
<div class="settings-section">
    <div class="section-header">
        <h2><i class="fas fa-user-circle"></i> 头像设置</h2>
    </div>

    <div class="avatar-section">
        <div class="avatar-container">
            <div class="avatar-preview" id="avatar-preview">
                {% if user.avatar %}
                    <img src="{{ user.avatar }}" alt="用户头像">
                {% else %}
                    <div class="default-avatar" id="default-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                {% endif %}
                <div class="avatar-loading" id="avatar-loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="avatar-actions">
                <label class="avatar-upload-btn">
                    <i class="fas fa-upload"></i> 上传新头像
                    <input type="file" id="avatar-file-input" accept="image/*">
                </label>
                <button type="button" class="btn-remove-avatar" id="remove-avatar-btn"
                        {% if not user.avatar %}disabled{% endif %}>
                    <i class="fas fa-trash"></i> 移除头像
                </button>
                <div class="form-hint">
                    支持 JPG、PNG 格式，文件大小不超过 4MB。建议使用正方形图片。
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 头像裁剪模态框 -->
<div class="avatar-modal" id="avatar-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-crop-alt"></i> 裁剪头像</h3>
            <button type="button" class="btn-close-modal" id="close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="crop-container">
                <img id="crop-image" style="max-width: 100%">
            </div>
            <div class="form-hint">
                拖动选框调整裁剪区域，确保头像在正方形区域内显示最佳效果。
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancel-crop-btn">
                <i class="fas fa-times"></i> 取消
            </button>
            <button type="button" class="btn btn-primary" id="confirm-crop-btn">
                <i class="fas fa-check"></i> 确认裁剪
            </button>
        </div>
    </div>
</div>

<!-- Profile Settings -->
<div class="settings-section">
    <div class="section-header">
        <h2><i class="fas fa-user"></i> 个人信息</h2>
    </div>

    <div id="profile-alert" class="alert"></div>

    <form id="profile-form">
        <div class="form-row">
            <div class="form-col">
                <div class="form-group">
                    <label for="username" class="form-label"><i class="fas fa-user-tag"></i> 用户名</label>
                    <input type="text" id="username" name="username" class="form-input" value="{{ user.username }}" readonly>
                    <div class="form-hint">用户名创建后不可更改</div>
                </div>
            </div>
            <div class="form-col">
                <div class="form-group">
                    <label for="email" class="form-label"><i class="fas fa-envelope"></i> 邮箱地址</label>
                    <input type="email" id="email" name="email" class="form-input" value="{{ user.email if user.email else '' }}" placeholder="请输入邮箱地址">
                    <div class="form-hint">用于接收重要通知和重置密码</div>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存更改</button>
            <button type="reset" class="btn btn-secondary"><i class="fas fa-undo"></i> 重置</button>
        </div>
    </form>
</div>

<!-- Password Settings -->
<div class="settings-section">
    <div class="section-header">
        <h2><i class="fas fa-lock"></i> 修改密码</h2>
    </div>

    <div id="password-alert" class="alert"></div>

    <form id="password-form">
        <div class="form-group">
            <label for="current-password" class="form-label"><i class="fas fa-key"></i> 当前密码</label>
            <input type="password" id="current-password" name="current_password" class="form-input" required>
        </div>

        <div class="form-group">
            <label for="new-password" class="form-label"><i class="fas fa-lock"></i> 新密码</label>
            <input type="password" id="new-password" name="new_password" class="form-input" required>
            <div class="form-hint">设置强密码</div>
            <div class="password-strength" id="password-strength"></div>
        </div>

        <div class="form-group">
            <label for="confirm-password" class="form-label"><i class="fas fa-lock"></i> 确认新密码</label>
            <input type="password" id="confirm-password" name="confirm_password" class="form-input" required>
            <div class="form-hint" id="password-match-hint"></div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-primary"><i class="fas fa-key"></i> 修改密码</button>
        </div>
    </form>
</div>

<!-- Security Settings -->
<div class="settings-section">
    <div class="section-header">
        <h2><i class="fas fa-shield-alt"></i> 安全设置</h2>
    </div>

    <div class="form-group">
        <label for="two-factor" class="form-label"><i class="fas fa-mobile-alt"></i> 双因素认证</label>
        <div class="toggle-container">
            <span>启用双因素认证增强账户安全</span>
            <label class="switch">
                <input type="checkbox" id="two-factor">
                <span class="slider round"></span>
            </label>
        </div>
        <div class="form-hint">启用后，登录时需要输入手机验证码</div>
    </div>

    <div class="form-group">
        <label for="session-timeout" class="form-label"><i class="fas fa-clock"></i> 会话超时</label>
        <select id="session-timeout" class="form-select">
            <option value="30">30分钟</option>
            <option value="60" selected>1小时</option>
            <option value="120">2小时</option>
            <option value="240">4小时</option>
            <option value="480">8小时</option>
        </select>
        <div class="form-hint">设置登录会话的自动超时时间</div>
    </div>

    <div class="button-group">
        <button type="button" class="btn btn-primary" id="save-security-btn"><i class="fas fa-save"></i> 保存安全设置</button>
    </div>
</div>

<!-- Danger Zone -->
<div class="settings-section danger-zone">
    <div class="section-header">
        <h2><i class="fas fa-exclamation-triangle"></i> 危险区域</h2>
    </div>

    <div class="form-group">
        <h3><i class="fas fa-trash-alt"></i> 删除账户</h3>
        <p>永久删除您的账户和所有相关数据。此操作不可撤销，请谨慎操作。</p>
        <button type="button" class="btn btn-danger" id="delete-account-btn"><i class="fas fa-trash"></i> 删除我的账户</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='js/avatar.js') }}"></script>
{% endblock %}