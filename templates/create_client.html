{% extends "base.html" %}

{% block title %}创建OAuth应用{% endblock %}

{% block extra_css %}
<style>
    /* Create client specific styles */
    .form-section {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .form-container {
        background-color: rgba(0, 0, 0, 0.4);
        padding: 30px;
        border-radius: 12px;
        flex: 1;
    }

    .example {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 6px;
        margin-top: 12px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        border-left: 3px solid #4285f4;
    }

    .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .info-card {
        background-color: rgba(0, 0, 0, 0.4);
        padding: 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        border-left: 4px solid #4285f4;
    }

    .info-card.success {
        border-left-color: #34a853;
    }

    .info-card h3 {
        margin-bottom: 15px;
        color: #4285f4;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-card.success h3 {
        color: #34a853;
    }

    .info-card p {
        margin-bottom: 12px;
        line-height: 1.5;
    }

    .info-card ul, .info-card ol {
        padding-left: 20px;
        margin-bottom: 15px;
    }

    .info-card li {
        margin-bottom: 8px;
        line-height: 1.4;
    }

    /* Error message styles */
    .error-message {
        background-color: rgba(234, 67, 53, 0.2);
        color: #ff6b6b;
        padding: 12px 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #ea4335;
        display: none;
    }

    .error-message.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block header %}
<div class="page-header">
    <h1><i class="fas fa-plus-circle"></i> 创建OAuth应用</h1>
    <p>配置您的OAuth应用，让其他用户可以通过您的应用进行登录授权</p>
</div>
{% endblock %}

{% block content %}
<!-- Error Message (Hidden by default) -->
<div class="error-message" id="error-message">
    <i class="fas fa-exclamation-circle"></i> <span id="error-text"></span>
</div>

<!-- Info Card -->
<div class="info-card">
    <h3><i class="fas fa-info-circle"></i> 什么是OAuth应用？</h3>
    <p>创建OAuth应用后，其他用户可以通过您的应用进行登录授权。您将获得：</p>
    <ul>
        <li><strong>Client ID</strong> - 应用的公开标识符</li>
        <li><strong>Client Secret</strong> - 应用的私密密钥（请妥善保管）</li>
    </ul>
    <p>其他用户只需要在您的应用中点击"使用OAuth登录"，即可完成授权流程。</p>
</div>

<!-- Form Section -->
<div class="form-section">
    <div class="form-container">
        <form method="POST" id="create-app-form">
            <div class="form-group">
                <label for="client_name" class="form-label"><i class="fas fa-tag"></i> 应用名称</label>
                <input type="text" name="client_name" id="client_name" class="form-input" placeholder="例如：我的博客应用" required>
                <div class="form-hint">为用户显示的应用名称，应简洁明了</div>
            </div>

            <div class="form-group">
                <label for="redirect_uris" class="form-label"><i class="fas fa-link"></i> 回调URL</label>
                <textarea name="redirect_uris" id="redirect_uris" class="form-textarea" placeholder="http://localhost:3000/auth/callback&#10;https://myapp.com/oauth/callback" required></textarea>
                <div class="form-hint">
                    用户授权后会跳转到这些URL，每行一个URL<br>
                    确保这些URL在您的应用中能够处理OAuth回调
                </div>
                <div class="example">
                    # 示例：<br>
                    http://localhost:3000/auth/callback<br>
                    https://myapp.com/oauth/callback<br>
                    https://myapp.com/login/oauth
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> 创建应用</button>
                <a href="{{ url_for('oauth_clients') }}" class="btn btn-secondary"><i class="fas fa-times"></i> 取消</a>
            </div>
        </form>
    </div>
</div>

<!-- Success Info Card -->
<div class="info-card success">
    <h3><i class="fas fa-lightbulb"></i> 下一步该做什么？</h3>
    <p>创建应用后，您将获得 <strong>Client ID</strong> 和 <strong>Client Secret</strong>。在您的应用中：</p>
    <ol>
        <li>将用户重定向到授权端点：<code>/oauth/authorize?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&response_type=code</code></li>
        <li>在回调URL处理授权码，并使用它交换访问令牌</li>
        <li>使用访问令牌调用API获取用户信息</li>
    </ol>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>
<script>
    // Create client specific functionality
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('create-app-form');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateClientForm()) {
                    this.submit();
                }
            });
        }

        // Initialize auto-resize for textareas
        const textarea = document.getElementById('redirect_uris');
        if (textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Initial resize
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // Check for flash messages
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if category == 'error' %}
                        showError('{{ message }}');
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}
    });

    // Enhanced form validation for create client
    function validateClientForm() {
        const clientName = document.getElementById('client_name').value.trim();
        const redirectUris = document.getElementById('redirect_uris').value.trim();

        if (!clientName) {
            showError('请输入应用名称');
            document.getElementById('client_name').focus();
            return false;
        }

        if (clientName.length < 2) {
            showError('应用名称至少需要2个字符');
            document.getElementById('client_name').focus();
            return false;
        }

        if (!redirectUris) {
            showError('请输入至少一个回调URL');
            document.getElementById('redirect_uris').focus();
            return false;
        }

        const uris = redirectUris.split('\n')
            .map(uri => uri.trim())
            .filter(uri => uri.length > 0);

        if (uris.length === 0) {
            showError('请输入至少一个有效的回调URL');
            document.getElementById('redirect_uris').focus();
            return false;
        }

        // Validate URL format
        for (let uri of uris) {
            if (!uri.startsWith('http://') && !uri.startsWith('https://')) {
                showError(`回调URL "${uri}" 格式不正确，必须以 http:// 或 https:// 开头`);
                document.getElementById('redirect_uris').focus();
                return false;
            }

            try {
                new URL(uri);
            } catch (err) {
                showError(`回调URL "${uri}" 格式不正确，请检查URI格式`);
                document.getElementById('redirect_uris').focus();
                return false;
            }
        }

        return true;
    }

    // Add input listeners to hide errors
    document.getElementById('client_name')?.addEventListener('input', hideError);
    document.getElementById('redirect_uris')?.addEventListener('input', hideError);
</script>
{% endblock %}